<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Festival - Simple Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c5f2d;
        }
        .status-bar {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        .status-bar.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-bar.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background-color: #2c5f2d;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 18px;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .stock-cell {
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            padding: 10px 20px;
            text-align: center;
            border-radius: 4px;
        }
        .stock-cell:hover {
            opacity: 0.8;
        }
        .stock-100 {
            background-color: #4caf50;
            color: white;
        }
        .stock-75 {
            background-color: #8bc34a;
            color: white;
        }
        .stock-50 {
            background-color: #ff9800;
            color: white;
        }
        .stock-25 {
            background-color: #f44336;
            color: white;
        }
        .stock-0 {
            background-color: #9e9e9e;
            color: white;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            background-color: #2c5f2d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn:hover {
            background-color: #1e4620;
        }
    </style>
    <script>
        // JSONBin Configuration
        const JSONBIN_API_KEY = '$2a$10$5J2bEaYJje4O1i40NLVVTu9u9Tz2kmlIl0xKoWpGr2vaIUPhp93ey';
        const JSONBIN_BIN_ID = '690a223c43b1c97be9987c36';
        
        let isUpdating = false;
        let lastSyncTime = null;
        
        // Update status bar
        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.className = 'status-bar';
            if (type === 'success') {
                statusBar.classList.add('success');
            } else if (type === 'error') {
                statusBar.classList.add('error');
            }
        }
        
        // Load stock levels from JSONBin on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            updateStatus('Loading stock levels...');
            loadStockLevels();
            
            // Auto-sync every 10 seconds to update from other devices
            setInterval(() => {
                if (!isUpdating) {
                    loadStockLevels(true); // silent load
                }
            }, 10000);
        });
        
        // Load stock levels from JSONBin
        async function loadStockLevels(silent = false) {
            try {
                if (!silent) updateStatus('Loading stock levels...');
                
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                console.log('Load response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded data:', data);
                    
                    const stockLevels = data.record.stockLevels || {};
                    
                    // Update each cell with saved data
                    const stockCells = document.querySelectorAll('.stock-cell');
                    stockCells.forEach((cell, index) => {
                        if (stockLevels[index] !== undefined) {
                            cell.textContent = stockLevels[index];
                            updateStockClass(cell, stockLevels[index]);
                        } else {
                            updateStockClass(cell, cell.textContent);
                        }
                    });
                    
                    lastSyncTime = new Date();
                    if (!silent) {
                        updateStatus(`Last synced: ${lastSyncTime.toLocaleTimeString()}`, 'success');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Load failed:', response.status, errorText);
                    updateStatus(`Load failed: ${response.status} - ${errorText}`, 'error');
                    
                    // Initialize display even if load fails
                    const stockCells = document.querySelectorAll('.stock-cell');
                    stockCells.forEach(cell => {
                        updateStockClass(cell, cell.textContent);
                    });
                }
            } catch (error) {
                console.error('Error loading stock levels:', error);
                updateStatus(`Error loading: ${error.message}`, 'error');
                
                // Initialize display even if load fails
                const stockCells = document.querySelectorAll('.stock-cell');
                stockCells.forEach(cell => {
                    updateStockClass(cell, cell.textContent);
                });
            }
        }
        
        // Save stock levels to JSONBin
        async function saveStockLevels() {
            isUpdating = true;
            updateStatus('Saving stock levels...');
            
            try {
                const stockCells = document.querySelectorAll('.stock-cell');
                const stockLevels = {};
                
                stockCells.forEach((cell, index) => {
                    stockLevels[index] = cell.textContent;
                });
                
                console.log('Saving stock levels:', stockLevels);
                
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify({
                        stockLevels: stockLevels
                    })
                });
                
                console.log('Save response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Save successful:', result);
                    lastSyncTime = new Date();
                    updateStatus(`Saved! Last synced: ${lastSyncTime.toLocaleTimeString()}`, 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Save failed:', response.status, errorText);
                    updateStatus(`Save failed: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                console.error('Error saving stock levels:', error);
                updateStatus(`Error saving: ${error.message}`, 'error');
            } finally {
                isUpdating = false;
            }
        }
        
        function cycleStock(cell) {
            const currentText = cell.textContent;
            let newStock;
            
            switch(currentText) {
                case '100%':
                    newStock = '75%';
                    break;
                case '75%':
                    newStock = '50%';
                    break;
                case '50%':
                    newStock = '25%';
                    break;
                case '25%':
                    newStock = '0%';
                    break;
                case '0%':
                    newStock = '100%';
                    break;
                default:
                    newStock = '100%';
            }
            
            cell.textContent = newStock;
            updateStockClass(cell, newStock);
            
            // Save to JSONBin whenever stock changes
            saveStockLevels();
        }
        
        function updateStockClass(cell, stock) {
            cell.className = 'stock-cell';
            if (stock === '100%') cell.classList.add('stock-100');
            else if (stock === '75%') cell.classList.add('stock-75');
            else if (stock === '50%') cell.classList.add('stock-50');
            else if (stock === '25%') cell.classList.add('stock-25');
            else if (stock === '0%') cell.classList.add('stock-0');
        }
        
        // Reset all stock to 100%
        async function resetAllStock() {
            if (confirm('Reset all stock levels to 100%?')) {
                const stockCells = document.querySelectorAll('.stock-cell');
                stockCells.forEach(cell => {
                    cell.textContent = '100%';
                    updateStockClass(cell, '100%');
                });
                await saveStockLevels();
            }
        }
        
        // Manual save button
        function manualSave() {
            saveStockLevels();
        }
        
        // Manual reload button
        function manualReload() {
            loadStockLevels();
        }
    </script>
</head>
<body>
    <h1>Chelmsford Hockey Club Beer & Cider Festival</h1>
    
    <div id="statusBar" class="status-bar">Initializing...</div>
    
    <div class="controls">
        <button class="btn" onclick="manualSave()">ðŸ’¾ Save Now</button>
        <button class="btn" onclick="manualReload()">ðŸ”„ Reload</button>
        <button class="btn" onclick="resetAllStock()">â†» Reset All to 100%</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Drink Name</th>
                <th>Stock Level</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>LIONHEART</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>RIBBLEHEAD BITTER</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>PENNINE DARK MILD</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>LEGACY</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>INFERNO</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>SWEENEY TODD</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>SIX LITTLE SHIPS</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>LUSHINGTONS</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>HEART OF DARKNESS</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>GRAVITAS</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>CAPTAIN BOB</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>SILVER ADDER</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>FIREDANCER</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>SELECT</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>RED RABBIT</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>BEE STING (Perry)</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>ELDERFLOWER</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>PINA COLADA</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>RASPBERRY MOJITO</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>WILD BERRY</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>MAN-GHOOOUL (Mango)</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>RHUBARB</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>LOW TIDE</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>PROPER JOB</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
            <tr><td>GHOST SHIP</td><td class="stock-cell" onclick="cycleStock(this)">100%</td></tr>
        </tbody>
    </table>
    
    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">
        <p>ðŸ’¡ <strong>Instructions:</strong> Click on any stock level to cycle through 100% â†’ 75% â†’ 50% â†’ 25% â†’ 0% â†’ 100%</p>
        <p>Changes are automatically saved and synced across all devices every 10 seconds</p>
        <p>Open browser console (F12) to see detailed debugging information</p>
    </div>
</body>
</html>
