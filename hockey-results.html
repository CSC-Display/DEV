<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fixtures</title>
  <!-- Link to Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Hide everything in body except .gms-wrapper */
    body > *:not(.gms-wrapper):not(.refresh-indicator) {
      display: none !important;
    }

    /* Inside .gms-wrapper hide everything except the table */
    .gms-wrapper > *:not(.gms-table-fixtures) {
      display: none !important;
    }

    /* Body Styling */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Refresh Indicator */
    .refresh-indicator {
      position: absolute;
      bottom: -40px;
      left: 0;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 400;
      color: #666;
      background-color: transparent;
      padding: 8px 15px;
      z-index: 1000;
      transition: color 0.3s ease;
    }

    .refresh-indicator.refreshing {
      color: #007bff;
    }

    /* Table Container */
    .gms-wrapper {
      width: 100%;
      max-width: 1000px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: visible;
      position: relative;
      margin-bottom: 50px;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .loading-overlay.active {
      display: flex;
    }

    /* Table Styling */
    .gms-table-fixtures {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
      font-weight: 400;
    }

    .gms-table-fixtures th,
    .gms-table-fixtures td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
    }

    /* Remove all background colors except header */
    .gms-table-fixtures td,
    .gms-table-fixtures tr:nth-child(even),
    .gms-table-fixtures tr:hover {
      background-color: transparent !important;
    }

    /* Header row: black background, white text */
    .gms-table-fixtures th {
      background-color: black !important;
      color: white !important;
      font-weight: 400 !important;
    }

    /* Set all cell text to black and normal weight */
    .gms-table-fixtures td {
      color: black !important;
      font-weight: 400 !important;
    }

    /* Hide Date and Venue Columns */
    .gms-table-fixtures th:nth-child(1),
    .gms-table-fixtures td:nth-child(1),
    .gms-table-fixtures th:nth-child(5),
    .gms-table-fixtures td:nth-child(5) {
      display: none;
    }

    /* Result styling */
    .result-score {
      font-weight: 600 !important;
      color: #2c5aa0 !important;
      text-align: center;
    }

    .result-vs {
      color: #666 !important;
      text-align: center;
      font-style: italic;
    }

    /* Status styling */
    .status-finished {
      color: #28a745 !important;
      font-weight: 500 !important;
    }

    .status-upcoming {
      color: #6c757d !important;
    }

    .status-live {
      color: #dc3545 !important;
      font-weight: 600 !important;
    }

  </style>
</head>
<body>

  <div class="refresh-indicator" id="refreshIndicator">
    Next refresh in <span id="countdown">15:00</span>
  </div>

  <div class="gms-wrapper gms-ajax"
       id="gmsWrapper"
       data-method="api-dynamic"
       data-show="fixtures"
       data-club_id="e9ba26d3-7e18-4772-abb0-584e887c9d38"
       data-sort_by="fixtureTime"
       data-options="showGender:yes">
    <div class="loading-overlay" id="loadingOverlay">
      <div>Refreshing fixtures...</div>
    </div>
  </div>

  <script src="https://gmsfeed.co.uk/js/api.js"></script>
  
  <script>
    // Auto-refresh functionality
    let refreshInterval;
    let countdownInterval;
    let timeLeft = 15 * 60; // 15 minutes in seconds

    function updateCountdown() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      const countdownElement = document.getElementById('countdown');
      if (countdownElement) {
        countdownElement.textContent = formattedTime;
      }
      
      timeLeft--;
      
      if (timeLeft < 0) {
        refreshGMSData();
        timeLeft = 15 * 60; // Reset to 15 minutes
      }
    }

    function processResultsColumn() {
      const table = document.querySelector('.gms-table-fixtures');
      if (!table) return;

      // Find the column that contains "vs" or is between home and away teams
      const rows = table.querySelectorAll('tr');
      
      rows.forEach((row, index) => {
        if (index === 0) return; // Skip header row
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) return;
        
        // Assuming structure: [Date(hidden), Time, Home Team, VS/Result, Away Team, Venue(hidden)]
        // The VS/Result column should be at index 3 (4th visible column, 3rd after hiding date)
        const resultCell = cells[3];
        if (!resultCell) return;
        
        const resultText = resultCell.textContent.trim();
        
        // Check if this looks like a score (contains numbers and possibly a dash or colon)
        const scorePattern = /^\d+\s*[-:]\s*\d+$/;
        const vsPattern = /^vs$/i;
        
        if (scorePattern.test(resultText)) {
          // This is a completed game with a score
          resultCell.classList.add('result-score');
          
          // Also update the time/status cell to show "Finished"
          const timeCell = cells[1]; // Time column
          if (timeCell && !timeCell.textContent.includes('Finished')) {
            timeCell.innerHTML = '<span class="status-finished">Finished</span>';
          }
        } else if (vsPattern.test(resultText)) {
          // This is an upcoming game
          resultCell.classList.add('result-vs');
          
          // Check if it's today's game or upcoming
          const timeCell = cells[1];
          if (timeCell) {
            const timeText = timeCell.textContent.trim();
            if (timeText.includes(':') && !timeText.includes('Finished')) {
              timeCell.classList.add('status-upcoming');
            }
          }
        } else if (resultText.toLowerCase().includes('live') || resultText.toLowerCase().includes('playing')) {
          // This might be a live game
          resultCell.classList.add('status-live');
          
          const timeCell = cells[1];
          if (timeCell) {
            timeCell.innerHTML = '<span class="status-live">LIVE</span>';
          }
        }
      });
    }

    function refreshGMSData() {
      const indicator = document.getElementById('refreshIndicator');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const wrapper = document.getElementById('gmsWrapper');
      
      // Show refreshing state
      if (indicator) {
        indicator.classList.add('refreshing');
        indicator.innerHTML = 'Refreshing fixtures...';
      }
      
      if (loadingOverlay) {
        loadingOverlay.classList.add('active');
      }
      
      try {
        // Clear existing content except loading overlay
        const existingTable = wrapper.querySelector('.gms-table-fixtures');
        if (existingTable) {
          existingTable.remove();
        }
        
        // Re-trigger GMS API call
        if (typeof window.gmsAPI !== 'undefined' && window.gmsAPI.refresh) {
          // If GMS API has a refresh method
          window.gmsAPI.refresh(wrapper);
        } else {
          // Alternative: reload the script to trigger fresh data
          const script = document.querySelector('script[src="https://gmsfeed.co.uk/js/api.js"]');
          if (script) {
            script.remove();
            const newScript = document.createElement('script');
            newScript.src = 'https://gmsfeed.co.uk/js/api.js';
            newScript.onload = function() {
              // GMS should automatically process the wrapper after script load
              setTimeout(() => {
                processResultsColumn(); // Process results after data loads
                if (loadingOverlay) {
                  loadingOverlay.classList.remove('active');
                }
              }, 2000);
            };
            document.body.appendChild(newScript);
          }
        }
        
        // Reset indicator after a delay
        setTimeout(() => {
          if (indicator) {
            indicator.classList.remove('refreshing');
            indicator.innerHTML = 'Next refresh in <span id="countdown">15:00</span>';
          }
          if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
          }
        }, 3000);
        
      } catch (error) {
        console.error('Error refreshing GMS data:', error);
        
        // Reset indicator on error
        if (indicator) {
          indicator.classList.remove('refreshing');
          indicator.innerHTML = 'Next refresh in <span id="countdown">15:00</span>';
        }
        if (loadingOverlay) {
          loadingOverlay.classList.remove('active');
        }
      }
    }

    function startAutoRefresh() {
      // Start countdown timer (updates every second)
      countdownInterval = setInterval(updateCountdown, 1000);
      
      // Initial countdown display
      updateCountdown();
    }

    // Monitor for table changes and process results
    function observeTableChanges() {
      const wrapper = document.getElementById('gmsWrapper');
      if (!wrapper) return;

      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList') {
            // Check if a table was added
            const table = wrapper.querySelector('.gms-table-fixtures');
            if (table) {
              setTimeout(() => {
                processResultsColumn();
              }, 100);
            }
          }
        });
      });

      observer.observe(wrapper, {
        childList: true,
        subtree: true
      });
    }

    // Initialize auto-refresh when page loads
    window.addEventListener('load', function() {
      // Wait a moment for GMS to initialize, then start auto-refresh
      setTimeout(() => {
        startAutoRefresh();
        observeTableChanges();
        processResultsColumn(); // Process any existing results
      }, 2000);
    });

    // Cleanup intervals when page unloads
    window.addEventListener('beforeunload', function() {
      if (refreshInterval) clearInterval(refreshInterval);
      if (countdownInterval) clearInterval(countdownInterval);
    });

    // Optional: Add manual refresh capability
    document.addEventListener('keydown', function(e) {
      // Press 'R' key to manually refresh
      if (e.key === 'r' || e.key === 'R') {
        timeLeft = 0; // Trigger immediate refresh
      }
    });
  </script>
  
</body>
</html>
